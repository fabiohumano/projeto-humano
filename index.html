import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, 
  collection, arrayUnion, arrayRemove 
} from 'firebase/firestore';
import { 
  Mic2, Music, Play, Cpu, Users, Mail, MapPin, 
  Instagram, Youtube, Headphones, Volume2, Waves, 
  Disc, ArrowRight, Settings, Save, Plus, Trash2, 
  MessageSquare, Camera, CheckCircle, Smartphone,
  ExternalLink, X, ChevronRight, Globe
} from 'lucide-react';

// --- CONFIGURAÇÃO DE SEGURANÇA ---
// No GitHub, estas variáveis não existem. Criamos um fallback para o app não travar.
const getFirebaseConfig = () => {
  try {
    return JSON.parse(__firebase_config);
  } catch (e) {
    return null; // Caso esteja no GitHub pessoal do utilizador
  }
};

const firebaseConfig = getFirebaseConfig();
let db, auth, appId;

if (firebaseConfig) {
  const app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';
}

const App = () => {
  const [view, setView] = useState('portfolio');
  const [scrolled, setScrolled] = useState(false);
  const [activeTab, setActiveTab] = useState('textos');
  
  // Dados de Backup (Caso o banco de dados não esteja ligado)
  const [siteData, setSiteData] = useState({
    heroTitle: "A ALMA DA MÚSICA É HUMANA.",
    heroDesc: "Produção musical, mixagem e masterização. O medo rouba sonhos, a música liberta-os.",
    phone: "32991064759",
    email: "humanoprojeto@gmail.com",
    address: "Rua XV de Novembro, 89 - Centro, Sapucaia - RJ",
    instagram: "fabio.humano",
    youtube: "@fabiobndtt",
    videos: ["https://www.youtube.com/watch?v=vNl-kuOCX8U"],
    testimonials: [
      { id: 1, name: "Diego Orfeu", text: "Trabalho impecável no HUMANO Studio." }
    ],
    photos: ["image_95df99.png", "image_965727.png", "image_965b41.png", "20220914_184904.jpg"]
  });

  useEffect(() => {
    // Escuta de Scroll
    const handleScroll = () => setScrolled(window.scrollY > 50);
    window.addEventListener('scroll', handleScroll);

    // Ligação Real com Firebase (Se configurado)
    if (db) {
      signInAnonymously(auth);
      const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config');
      const unsub = onSnapshot(configRef, (snap) => {
        if (snap.exists()) setSiteData(prev => ({ ...prev, ...snap.data() }));
        else setDoc(configRef, siteData);
      });
      return () => {
        unsub();
        window.removeEventListener('scroll', handleScroll);
      };
    }

    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const handleSave = async () => {
    if (db) {
      const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config');
      await updateDoc(configRef, siteData);
      alert("✅ Gravado com sucesso no Banco de Dados!");
    } else {
      alert("⚠️ Estás em modo de demonstração. Para gravar no GitHub pessoal, precisas de configurar o teu próprio Firebase.");
    }
  };

  const renderPortfolio = () => (
    <div className="animate-in fade-in duration-1000">
      {/* Hero */}
      <section className="min-h-screen flex items-center px-6 max-w-7xl mx-auto pt-20">
        <div className="grid lg:grid-cols-2 gap-16 items-center w-full">
          <div className="z-10">
            <div className="inline-flex items-center gap-2 px-3 py-1 bg-zinc-900 border border-zinc-800 rounded-full mb-8">
              <span className="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>
              <span className="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">SÃO PAULO 2008 • ORIGINALIDADE</span>
            </div>
            <h1 className="text-6xl md:text-8xl lg:text-9xl font-black mb-8 leading-[0.85] uppercase tracking-tighter">
              {siteData.heroTitle.split(' ').map((word, i) => (
                <span key={i} className={['MÚSICA', 'HUMANA.'].includes(word.toUpperCase()) ? 'text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-600' : ''}>
                  {word}{' '}
                </span>
              ))}
            </h1>
            <p className="text-xl text-zinc-400 mb-12 max-w-lg leading-relaxed italic font-light">
              {siteData.heroDesc}
            </p>
            <div className="flex flex-wrap gap-6">
              <a href={`https://wa.me/55${siteData.phone}`} target="_blank" className="px-10 py-5 bg-white text-black font-black rounded-full hover:bg-zinc-200 transition-all flex items-center gap-3 shadow-2xl">
                <Smartphone size={20} /> WHATSAPP
              </a>
              <button onClick={() => setView('admin')} className="px-8 py-5 border border-zinc-800 rounded-full hover:bg-zinc-900 transition-all font-bold text-sm tracking-widest text-zinc-500 uppercase">
                O Estúdio
              </button>
            </div>
          </div>
          
          <div className="hidden lg:flex justify-center">
            <div className="w-full max-w-md aspect-square rounded-[4rem] border border-white/5 bg-zinc-900/30 backdrop-blur-xl flex items-center justify-center relative overflow-hidden group">
              <div className="flex items-end gap-3 h-48 z-10">
                {[...Array(6)].map((_, i) => (
                  <div key={i} className="w-4 bg-amber-500/40 rounded-full" style={{ 
                    height: '20%', 
                    animation: 'bounce 0.8s ease-in-out infinite',
                    animationDelay: `${i * 0.1}s`
                  }} />
                ))}
              </div>
              <Disc size={450} className="absolute text-white/5 animate-spin opacity-10" style={{ animationDuration: '20s' }} />
            </div>
          </div>
        </div>
      </section>

      {/* Videos */}
      {siteData.videos.length > 0 && (
        <section className="py-32 border-t border-zinc-900 bg-black/50">
          <div className="max-w-7xl mx-auto px-6">
            <h2 className="text-4xl font-black mb-16 uppercase italic">Portfólio <span className="text-amber-500 font-light tracking-widest">Visual</span></h2>
            <div className="grid md:grid-cols-2 gap-12">
              {siteData.videos.map((url, i) => {
                const id = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/)?.[1];
                return id && (
                  <div key={i} className="relative pt-[56.25%] rounded-3xl overflow-hidden border border-white/5 bg-black shadow-2xl">
                    <iframe className="absolute inset-0 w-full h-full" src={`https://www.youtube.com/embed/${id}`} allowFullScreen />
                  </div>
                );
              })}
            </div>
          </div>
        </section>
      )}

      {/* Footer */}
      <footer className="py-32 border-t border-zinc-900 text-center bg-black">
        <div className="max-w-4xl mx-auto px-6">
            <div className="flex justify-center gap-10 mb-12 opacity-30">
                <Instagram size={24} /> <Youtube size={24} /> <Smartphone size={24} />
            </div>
            <p className="text-zinc-600 text-xs font-mono uppercase tracking-[0.6em] mb-4">{siteData.email}</p>
            <p className="text-zinc-500 text-[10px] uppercase tracking-widest font-bold">© 2025 HUMANO Studio | Fabio Benedetti</p>
            <button onClick={() => setView('admin')} className="mt-16 text-[9px] text-zinc-800 uppercase tracking-widest hover:text-amber-500 transition-colors">Área Restrita</button>
        </div>
      </footer>
    </div>
  );

  const renderAdmin = () => (
    <div className="pt-32 pb-40 px-6 max-w-5xl mx-auto animate-in slide-in-from-bottom-10 duration-700">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-16 gap-8 border-b border-zinc-900 pb-12">
        <div>
          <h2 className="text-6xl font-black uppercase tracking-tighter leading-none">Painel <span className="text-amber-500 italic">Cérebro</span></h2>
          <p className="text-zinc-500 text-[10px] mt-3 uppercase tracking-widest font-mono">Gestão Profissional do Site</p>
        </div>
        <div className="flex gap-4 w-full md:w-auto">
            <button onClick={() => setView('portfolio')} className="flex-1 md:flex-none px-8 py-5 border border-zinc-800 text-zinc-500 font-bold rounded-2xl hover:bg-zinc-900 transition-all text-xs uppercase">Sair do Admin</button>
            <button onClick={handleSave} className="flex-1 md:flex-none px-10 py-5 bg-amber-500 text-black font-black rounded-2xl flex items-center justify-center gap-2 hover:bg-amber-400 transition-all shadow-xl shadow-amber-500/20">
                <Save size={18} /> GRAVAR NO SITE
            </button>
        </div>
      </div>

      <div className="grid md:grid-cols-4 gap-8">
          <div className="md:col-span-1 space-y-2">
            {[
                { id: 'textos', label: 'Mensagens', icon: Mic2 },
                { id: 'videos', label: 'Vídeos', icon: Youtube },
                { id: 'contactos', label: 'Contactos', icon: Smartphone }
            ].map(tab => (
                <button 
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`w-full flex items-center gap-3 p-4 rounded-2xl text-xs font-bold uppercase tracking-widest transition-all ${activeTab === tab.id ? 'bg-amber-500 text-black' : 'bg-zinc-900 text-zinc-500 border border-zinc-800 hover:border-zinc-700'}`}
                >
                    <tab.icon size={16} /> {tab.label}
                </button>
            ))}
          </div>

          <div className="md:col-span-3">
              {activeTab === 'textos' && (
                <div className="glass-card p-10 rounded-[3rem] space-y-8">
                    <div>
                        <label className="text-[10px] font-black uppercase text-zinc-600 mb-2 block">Título Principal</label>
                        <input 
                            type="text" 
                            value={siteData.heroTitle}
                            onChange={(e) => setSiteData({...siteData, heroTitle: e.target.value.toUpperCase()})}
                            className="w-full bg-black border border-zinc-800 p-5 rounded-2xl outline-none focus:border-amber-500 transition-all font-black text-xl uppercase"
                        />
                    </div>
                    <div>
                        <label className="text-[10px] font-black uppercase text-zinc-600 mb-2 block">Subtexto / Frase</label>
                        <textarea 
                            value={siteData.heroDesc}
                            onChange={(e) => setSiteData({...siteData, heroDesc: e.target.value})}
                            className="w-full bg-black border border-zinc-800 p-5 rounded-2xl h-32 outline-none focus:border-amber-500 italic"
                        />
                    </div>
                </div>
              )}

              {activeTab === 'videos' && (
                <div className="glass-card p-10 rounded-[3rem]">
                    <div className="flex gap-4 mb-10">
                        <input 
                            id="v-in"
                            type="text" 
                            placeholder="Link do YouTube..." 
                            className="flex-1 bg-black border border-zinc-800 p-5 rounded-2xl outline-none focus:border-amber-500"
                        />
                        <button 
                            onClick={() => { const el = document.getElementById('v-in'); setSiteData({...siteData, videos: [...siteData.videos, el.value]}); el.value = ''; }}
                            className="px-8 bg-white text-black font-black rounded-2xl text-xs uppercase"
                        >Adicionar</button>
                    </div>
                    <div className="grid gap-4">
                        {siteData.videos.map((v, i) => (
                            <div key={i} className="flex justify-between items-center bg-zinc-950 p-5 rounded-2xl border border-zinc-900 group">
                                <span className="text-[10px] text-zinc-500 truncate max-w-[300px] font-mono">{v}</span>
                                <button onClick={() => setSiteData({...siteData, videos: siteData.videos.filter(vid => vid !== v)})} className="p-2 text-zinc-800 hover:text-red-500 transition-colors">
                                    <Trash2 size={16} />
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
              )}

              {activeTab === 'contactos' && (
                <div className="glass-card p-10 rounded-[3rem] space-y-8">
                    <div className="grid md:grid-cols-2 gap-8">
                        <div>
                            <label className="text-[10px] font-black uppercase text-zinc-600 mb-2 block">WhatsApp</label>
                            <input 
                                type="text" 
                                value={siteData.phone}
                                onChange={(e) => setSiteData({...siteData, phone: e.target.value})}
                                className="w-full bg-black border border-zinc-800 p-4 rounded-xl outline-none focus:border-amber-500"
                            />
                        </div>
                        <div>
                            <label className="text-[10px] font-black uppercase text-zinc-600 mb-2 block">E-mail</label>
                            <input 
                                type="text" 
                                value={siteData.email}
                                onChange={(e) => setSiteData({...siteData, email: e.target.value})}
                                className="w-full bg-black border border-zinc-800 p-4 rounded-xl outline-none focus:border-amber-500"
                            />
                        </div>
                    </div>
                </div>
              )}
          </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 selection:bg-amber-500 selection:text-black">
      {/* Navigation */}
      <nav className={`fixed top-0 w-full z-50 transition-all duration-300 ${scrolled || view !== 'portfolio' ? 'bg-zinc-950/95 backdrop-blur-md py-4 border-b border-zinc-900' : 'bg-transparent py-8'}`}>
        <div className="max-w-7xl mx-auto px-6 flex justify-between items-center">
          <div className="flex items-center gap-2 group cursor-pointer" onClick={() => setView('portfolio')}>
            <div className="w-10 h-10 bg-amber-500 rounded-full flex items-center justify-center group-hover:rotate-12 transition-transform shadow-lg shadow-amber-500/20">
              <Disc className="text-black" size={24} />
            </div>
            <div className="flex flex-col leading-none">
              <span className="text-xl font-black tracking-tighter uppercase">Fabio Benedetti</span>
              <span className="text-[10px] text-amber-500 font-bold tracking-widest uppercase">Projeto HUMANO</span>
            </div>
          </div>
          
          <div className="flex gap-4 items-center">
            <button onClick={() => setView('portfolio')} className={`text-[10px] font-black uppercase tracking-widest transition-colors ${view === 'portfolio' ? 'text-amber-500' : 'text-zinc-500 hover:text-white'}`}>Site</button>
            <button 
              onClick={() => setView('admin')} 
              className={`flex items-center gap-2 px-6 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${view === 'admin' ? 'bg-amber-500 text-black shadow-lg shadow-amber-500/20' : 'bg-zinc-900 text-zinc-400 border border-zinc-800'}`}
            >
              <Settings size={14} /> {view === 'admin' ? 'Painel Aberto' : 'Área Exclusiva'}
            </button>
          </div>
        </div>
      </nav>

      {view === 'portfolio' ? renderPortfolio() : renderAdmin()}

      <style>{`
        @keyframes bounce { 0%, 100% { transform: scaleY(0.4); } 50% { transform: scaleY(1.2); } }
      `}</style>
    </div>
  );
};

export default App;
